<div class="chat-container">
  <!-- Заголовок и управление -->
  <header class="chat-header">
    <h2>Чат с {{ model() }}</h2>

    <div class="controls">
      <!-- Режимы -->
      <fieldset class="mode-group">
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === 'book'"
            (change)="mode.set('book'); sendBookFirstMessage()"
          />
          Рекомендуй книги
        </label>
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === 'json'"
            (change)="mode.set('json'); clearChat()"
          />
          Ответы в формате JSON
        </label>
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === null"
            (change)="mode.set(null); clearChat()"
          />
          Обычный режим
        </label>
      </fieldset>

      <!-- Кнопка очистки -->
      <button (click)="clearChat()" [disabled]="isLoading()">Очистить чат</button>

      <!-- Настройки -->
      <div class="settings">
        <label>
          Температура:
          <select [(ngModel)]="temperature" [disabled]="isLoading()">
            <option [ngValue]="0">0 (детерминированно)</option>
            <option [ngValue]="0.7">0.7 (уравновешенно)</option>
            <option [ngValue]="1.2">1.2 (креативно)</option>
            <option [ngValue]="2">2 (сходим с ума)</option>
          </select>
        </label>

        <label>
          LLM:
          <select [(ngModel)]="model" [disabled]="isLoading()">
            <option [ngValue]="Model.DeepSeek_V3_2">DeepSeek 3.2V</option>
            <option [ngValue]="Model.Gemini_2_0_Flash">Gemini 2.0 Flash</option>
            <option [ngValue]="Model.Grok_4_Fast">Grok 4 Fast</option>
          </select>
        </label>
      </div>
    </div>
  </header>

  <!-- Сообщения -->
  <main class="chat-messages">
    @for (msg of messages(); track msg) {
      @if (msg.role === 'user' || msg.role === 'assistant') {
        <article class="message" [class.user]="msg.role === 'user'">
          <header>
            <strong>{{ msg.role === 'user' ? 'Вы' : model() }}:</strong>
          </header>

          @if (formatJson(msg.content); as json) {
            <pre class="json-response">{{ json }}</pre>
          } @else {
            <p class="formatted-text">{{ msg.content }}</p>
          }

          @if (msg.usage && (msg.usage.prompt_tokens || msg.usage.completion_tokens)) {
            <footer class="message-meta">
              @if (msg.usage.prompt_tokens) {
                <span class="tokens">Запрос: {{ msg.usage.prompt_tokens }} токенов</span>
              }
              @if (msg.usage.completion_tokens) {
                <span class="tokens">Ответ: {{ msg.usage.completion_tokens }} токенов</span>
              }
              @if (msg.timeOfResponse) {
                <span class="time">⏱️ {{ msg.timeOfResponse }} мс</span>
              }
            </footer>
          }
        </article>
      }
    }

    @if (isLoading()) {
      <article class="message assistant">
        <strong>{{ model() }}:</strong>
        <p>Думает...</p>
      </article>
    }
  </main>

  <!-- Ввод сообщения -->
  <footer class="chat-input">
    <textarea
      [(ngModel)]="userInput"
      placeholder="Введите сообщение..."
      (keydown.enter)="sendMessage(); $event.preventDefault()"
      [disabled]="isLoading()"
      rows="3"
    ></textarea>

    <div class="input-actions">
      <button
        type="button"
        (click)="sendMessage()"
        [disabled]="!userInput.trim() || isLoading()"
      >
        Отправить
      </button>

      <button
        type="button"
        (click)="sendSystemPromptMessage()"
        [disabled]="!userInput.trim() || isLoading()"
      >
        Изменить system prompt
      </button>
    </div>
  </footer>
</div>

<!-- Ошибки -->
@if (error()) {
  <div class="error" role="alert">{{ error() }}</div>
}
