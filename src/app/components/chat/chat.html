<div class="chat-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <header class="chat-header">
    <h2>–ß–∞—Ç —Å {{ model() }}</h2>

    <div class="controls">
      <!-- –†–µ–∂–∏–º—ã -->
      <fieldset class="mode-group">
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === 'book'"
            (change)="mode.set('book'); sendBookFirstMessage()"
          />
          –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–Ω–∏–≥–∏
        </label>
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === 'json'"
            (change)="mode.set('json'); clearChat()"
          />
          –û—Ç–≤–µ—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
        </label>
        <label>
          <input
            type="radio"
            name="mode"
            [checked]="mode() === null"
            (change)="mode.set(null); clearChat()"
          />
          –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
        </label>
      </fieldset>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ -->
      <button (click)="clearChat()" [disabled]="isLoading()">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>

      <button (click)="summarizeChat()" [disabled]="messages().length === 0 || isLoading()">
        üìù –°–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥
      </button>

      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <div class="settings">
        <label>
          –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:
          <select [(ngModel)]="temperature" [disabled]="isLoading()">
            <option [ngValue]="0">0 (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ)</option>
            <option [ngValue]="0.7">0.7 (—É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ)</option>
            <option [ngValue]="1.2">1.2 (–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ)</option>
            <option [ngValue]="2">2 (—Å—Ö–æ–¥–∏–º —Å —É–º–∞)</option>
          </select>
        </label>

        <label>
          LLM:
          <select [(ngModel)]="model" [disabled]="isLoading()">
            <option [ngValue]="Model.DeepSeek_V3_2">DeepSeek 3.2V</option>
            <option [ngValue]="Model.Gemini_2_0_Flash">Gemini 2.0 Flash</option>
            <option [ngValue]="Model.Grok_4_Fast">Grok 4 Fast</option>
          </select>
        </label>
      </div>
    </div>
  </header>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <main class="chat-messages">
    @for (msg of messages(); track msg) {
      <article class="message" [class.user]="msg.role === 'user'">
        <header>
          <strong>{{ msg.role === 'user' ? '–í—ã' : (msg.role === 'assistant' ? model() : 'System') }}:</strong>
        </header>

        @if (formatJson(msg.content); as json) {
          <pre class="json-response">{{ json }}</pre>
        } @else {
          <p class="formatted-text">{{ msg.content }}</p>
        }

        @if (msg.usage && (msg.usage.prompt_tokens || msg.usage.completion_tokens)) {
          <footer class="message-meta">
            @if (msg.usage.prompt_tokens) {
              <span class="tokens">–ó–∞–ø—Ä–æ—Å: {{ msg.usage.prompt_tokens }} —Ç–æ–∫–µ–Ω–æ–≤</span>
            }
            @if (msg.usage.completion_tokens) {
              <span class="tokens">–û—Ç–≤–µ—Ç: {{ msg.usage.completion_tokens }} —Ç–æ–∫–µ–Ω–æ–≤</span>
            }
            @if (msg.timeOfResponse) {
              <span class="time">‚è±Ô∏è {{ msg.timeOfResponse }} –º—Å</span>
            }
          </footer>
        }
      </article>
    }

    @if (isLoading()) {
      <article class="message assistant">
        <strong>{{ model() }}:</strong>
        <p>–î—É–º–∞–µ—Ç...</p>
      </article>
    }
  </main>

  <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <footer class="chat-input">
    <textarea
      [(ngModel)]="userInput"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
      (keydown.enter)="sendMessage(); $event.preventDefault()"
      [disabled]="isLoading()"
      rows="3"
    ></textarea>

    <div class="input-actions">
      <button
        type="button"
        (click)="sendMessage()"
        [disabled]="!userInput.trim() || isLoading()"
      >
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
      </button>

      <button
        type="button"
        (click)="sendSystemPromptMessage()"
        [disabled]="!userInput.trim() || isLoading()"
      >
        –ò–∑–º–µ–Ω–∏—Ç—å system prompt
      </button>
    </div>
  </footer>
</div>

<!-- –û—à–∏–±–∫–∏ -->
@if (error()) {
  <div class="error" role="alert">{{ error() }}</div>
}
